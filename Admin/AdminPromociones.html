<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <link href="styloAdmin.css" rel="stylesheet" />

  <!-- logotipo -->
  <link rel="icon" type="image/x-icon" href="src/Logotipo.png">

  <!-- Fonts and icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
    integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <title>Administrar Promociones</title>
</head>

<body>

  <!-- Navbar_AdminPromociones-->
  <nav class="navbar navbar-expand-lg border-bottom text-dark">
   
    <button class="navbar-toggler " style="background: #a0d6ef91;" type="button" data-toggle="collapse"
      data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false"
      aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
      <ul class="navbar-nav">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-toggle="dropdown"
            aria-expanded="false">
            Usuarios
          </a>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="#">Administrar Usuarios</a>
            <a class="dropdown-item" href="AdminDonaciones.html">Visualizar Donaciones</a>
            <a class="dropdown-item" href="AdminRoles.html">Administrar Roles</a>
          </div>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-toggle="dropdown"
            aria-expanded="false">
            Productos
          </a>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="AdminProducto.html">Ingreso de Productos</a>
            <a class="dropdown-item" href="AdminEspecies.html">Especies</a>
            <a class="dropdown-item" href="AdminVenta.html">Ventas</a>
            <a class="dropdown-item" href="AdminDespacho.html">Despachos</a>
              <a class="dropdown-item" href="AdminSeguimiento.html">Seguimiento</a>
            <a class="dropdown-item" href="AdminDashboard.html">Resultados Ventas/dashboard</a>
          </div>
        </li>
      </ul>
    </div>
    <nav class="navbar navbar-expand-lg">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link mr-4 text-dark" href="/Login.html">Cerrar Sesion</a>
        </li>
      </ul>
    </nav>
  </nav>
  <!-- Fin navbar -->

  <div class="container mt-5">
    <div class="row justify-content-md-center">
      <div class="col-sm-9">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">ADMINISTRAR PROMOCIONES</h5>
            <div class="form-row">
              <div class="form-group col-m-4 mt-1">
                <label for="inputFecha_inicioPromocion">Fecha de Inicio</label>
                <input type="date" class="form-control" id="inputFecha_inicioPromocion" required>
                <label for="inputFecha_finPromocion">Fecha de Término</label>
                <input type="date" class="form-control" id="inputFecha_finPromocion" required>
                <label for="inputDescuentoPromocion">Descuento</label>
                <input type="text" class="form-control" id="inputDescuentoPromocion" required>
                <label for="inputEstadoPromocion">Estado</label>
                <input type="text" class="form-control" id="inputEstadoPromocion" required>
                <label for="inputIdProductoPromocion">ID Producto</label>
                <input type="text" class="form-control" id="inputIdProductoPromocion" required>
                <label for="inputNombrePromocion">Nombre</label>
                <input type="text" class="form-control" id="inputNombrePromocion" required>
              </div>
              <div class="col-5 m-2">
                <a id="btnAgregarPromocion" class="btn btn-success col-md-4 mt-1 mt-4">Ingresar</a>
                <a id="btnModificarPromocion" class="btn btn-info col-md-4 mt-1 mt-4">Confirmar</a>
                <a id="btnCancelarEditarPromocion" class="btn btn-danger col-md-4 mt-1 mt-4">Cancelar</a>
              </div>
            </div>
            <div class="row mt-4 mb-4">
              <div class="col-sm-12">
                <div class="card" style="height: 100%;">
                  <div class="card-body">
                    <h5 class="card-title">Promociones</h5>
                    <div class="table-responsive">
                      <table class="table" id="tablaPromocion">
                        <thead class="thead-dark">
                          <tr>
                            <th scope="col">ID_PROMOCIONES</th>
                            <th scope="col">NOMBRE</th>
                            <th scope="col">FECHA_INICIO</th>
                            <th scope="col">FECHA_FIN</th>
                            <th scope="col">DESCUENTO</th>
                            <th scope="col">ESTADO</th>
                            <th scope="col">ID_PRODUCTOS</th>
                            <th scope="col">PRECIO_CON_DESCUENTO</th>
                            <th scope="col">ACCIONES</th>
                          </tr>
                        </thead>
                        <tbody id="tablaPromocionBody">
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</body>


<script> var API_URL = "http://localhost:5500/API";</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"
integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
integrity="sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2"
crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>




<script>

//buscar las Promociones en la api
 
$(document).ready(function() {
  getPromociones();
});

getPromociones = () => {
  var productosMap = {};

  // Obtener las promociones de la API
  $.ajax({
    url: `${API_URL}/Promociones`,
    type: 'GET',
    dataType: 'json',
    success: function(promociones) {
      // Obtener los productos de la API
      $.ajax({
        url: `${API_URL}/AdminProducto`,
        type: 'GET',
        dataType: 'json',
        success: function(productos) {
          
          // Crear un objeto para almacenar los productos por ID
          productosMap = productos.reduce(function(map, producto) {
            map[producto.ID_PRODUCTO] = producto;
            console.log(producto);
            return map;
          }, {});

          promociones.forEach(function(promocion) {
            
            // Obtener los datos de la promoción
            var idProducto = promocion.ID_PRODUCTO;
            var idPromocion = promocion.ID_PROMOCIONES;
            var nombre = promocion.NOMBRE;
            var fechaInicio = moment(promocion.FECHA_INICIO).format('YYYY-MM-DD');
            var fechaFin = moment(promocion.FECHA_FIN).format('YYYY-MM-DD');
            var descuento = promocion.DESCUENTO;
            var estado = promocion.ESTADO;
            
            
            // Obtener el producto correspondiente utilizando el ID del producto
            var producto = productosMap[idProducto];
            //if (producto && idProducto === producto.ID_PRODUCTO) {
            //idProducto = producto;
            //}


            if (estado === 0 || estado === null) {
          console.log(`La promoción con ID ${idPromocion} tiene estado ${estado} y no se muestra en la tabla.`);
          return;
        }  
        if (producto && producto.ID_PRODUCTO === idProducto) {
    var precioOriginal = producto.VALOR;
    var precioConDescuento = calcularPrecioConDescuento(precioOriginal, descuento);

    // Agregar los datos al tbody de la tabla
    $('#tablaPromocionBody').append(
      `<tr>
        <td>${idPromocion}</td>
        <td>${nombre}</td>
        <td>${fechaInicio}</td>
        <td>${fechaFin}</td>
        <td>${descuento}</td>
        <td>${estado}</td>
        <td>${idProducto}</td>
        <td>${precioOriginal} (${precioConDescuento})</td>
        <td>
          <div class="btn-group btn-group-sm" role="group" aria-label="Basic example">
            <button type="button" class="btn btn-info btnEditarPromocion"><i class="fa-solid fa-pencil"></i></button>
            <button type="button" class="btn btn-danger btnEliminarPromocion"><i class="fa-solid fa-trash"></i></button>
          </div>
        </td>
      </tr>`
    );
  } else {
    console.log(`La promoción con ID ${idPromocion} tiene estado 0 o no coincide con ningún producto y no se muestra en la tabla.`);
  }
});
          }
        });
      }
    });
  };

  function calcularPrecioConDescuento(precioOriginal, porcentajeDescuento) {
    var precio = parseFloat(precioOriginal);
    var descuento = parseFloat(porcentajeDescuento);
    var precioConDescuento = precio - (precio * descuento / 100);
    return precioConDescuento.toFixed(2);
  }

  //botones invisibles
  $('#btnModificarPromocion').hide();
  $('#btnCancelarEditarPromocion').hide();

  //añadir Promocion a la lista con jquery
  $(document).on('click', '#btnAgregarPromocion', function(){
    var fechaInicio = $('#inputFecha_inicioPromocion').val();
    var fechaFin = $('#inputFecha_finPromocion').val();
    var descuento = $('#inputDescuentoPromocion').val();
    var estado = $('#inputEstadoPromocion').val();
    var idProducto = $('#inputIdProductoPromocion').val();
    var nombre = $('#inputNombrePromocion').val();
        
    $.ajax({
      url: `${API_URL}/Promociones`,
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify ({
        FECHA_INICIO  : fechaInicio ,
        FECHA_FIN:   fechaFin,
        DESCUENTO:   descuento,
        ESTADO:   estado,
        ID_PRODUCTOS:   idProducto,
        NOMBRE:   nombre
      }),
      success: function(respuesta) {
        Swal.fire(
          'Promocion Ingresada!',
          'Presione "ok" para continuar.',
          'success'
        );
        limpiarFormulario();
        actualizarTabla();
      }
    });
  });
  

//entregar ultimo id
ultimoId = () => {
  let ultimoId = $("#tablaPromocion tbody tr:last th").text();
  let value = parseInt(ultimoId) + 1;
  if (isNaN(value)) {
    value = 1;
  }
  return value;
};

  
//botón BORRAR
$(document).on('click', '.btnEliminarPromocion', function(e) {
  const swalWithBootstrapButtons = Swal.mixin({
    customClass: {
      confirmButton: 'btn btn-success',
      cancelButton: 'btn btn-danger'
    },
    buttonsStyling: false
  });

  swalWithBootstrapButtons.fire({
    title: 'Desea cambiar el estado de la promoción?',
    text: 'El estado se cambiará a 0.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Si, Cambiar estado!',
    cancelButtonText: 'No, Cancelar!',
    reverseButtons: true
  }).then((result) => {
    if (result.isConfirmed) {
      var idPromocion = $(this).closest('tr').find('td:first-child').text();

      // Realizar la solicitud PATCH para cambiar el estado a 0
      $.ajax({
        url: `${API_URL}/Promociones`,
        type: 'PATCH',
        dataType: 'json',
        data: JSON.stringify({ ESTADO: 0 }),
        contentType: 'application/json',
        success: function(respuesta) {
          console.log('Estado de la promoción cambiado');
          // Aquí puedes realizar cualquier otra acción que necesites, como actualizar la tabla
          actualizarTabla();
          swalWithBootstrapButtons.fire(
            'Estado cambiado!',
            'Presione "OK" para finalizar.',
            'success'
          );
        },
        error: function() {
          swalWithBootstrapButtons.fire(
            'Error',
            'No se pudo cambiar el estado de la promoción.',
            'error'
          );
        }
      });
    } else if (result.dismiss === Swal.DismissReason.cancel) {
      swalWithBootstrapButtons.fire(
        'Cancelado.',
        'El estado de la promoción no ha sido cambiado.',
        'error'
      );
    }
  });
});

function actualizarTabla() {
  $('#tablaPromocion tbody').empty();
  getPromociones();
}

//Editar Promocion
$("#tablaPromocion tbody").on("click", ".btnEditarPromocion", function(e) {
  $('#btnAgregarPromocion').hide();
  $('#btnModificarPromocion').show();
  e.preventDefault();

  var fila = $(this).closest('tr');
  var idPromocion = fila.find('td:eq(0)').text();
  var nombre = fila.find('td:eq(1)').text();
  var fechaInicio = fila.find('td:eq(2)').text();
  var fechaFin = fila.find('td:eq(3)').text();
  var descuento = fila.find('td:eq(4)').text();
  var estado = fila.find('td:eq(5)').text();
  var idProducto = fila.find('td:eq(6)').text();

  $("#inputIdPromocion").val(idPromocion);
  $("#inputNombrePromocion").val(nombre);
  $("#inputFecha_inicioPromocion").val(fechaInicio);
  $("#inputFecha_finPromocion").val(fechaFin);
  $("#inputDescuentoPromocion").val(descuento);
  $("#inputEstadoPromocion").val(estado);
  $("#inputIdProductoPromocion").val(idProducto);

  $('#btnModificarPromocion').show();
  $('#btnCancelarEditarPromocion').show();
  $('#btnAgregarPromocion').hide();
});

//modificar Promocion
  $("#btnModificarPromocion").click(function () {
    var idPromocion = $("#inputIdPromocion").val();
    var nombre = $("#inputNombrePromocion").val();
    var fechaInicio = $("#inputFecha_inicioPromocion").val();
    var fechaFin = $("#inputFecha_finPromocion").val();
    var descuento = $("#inputDescuentoPromocion").val();
    var estado = $("#inputEstadoPromocion").val();
    var idProducto = $("#inputIdProductoPromocion").val();
    
  

    $.ajax({
          url: `${API_URL}/Promociones`,
          type: 'PATCH',
          contentType: 'application/json',
          crossDomain: true,
          data: JSON.stringify({
            FECHA_INICIO : fechaInicio ,
            FECHA_FIN:   fechaFin,
            DESCUENTO:   descuento,
            ESTADO:   estado,
            ID_PRODUCTOS:   idProducto,
            ID_PROMOCIONES : idPromocion  ,
            NOMBRE:  nombre
          }),
          success: function(respuesta){
            Swal.fire(
          'Promocion modificada!',
          'Presione "ok" para finalizar.',
          'success'
      );
      limpiarFormulario();
      actualizarTabla();
      $('#btnCancelarEditarPromocion').hide();
      $('#btnModificarPromocion').hide();
      $('#btnAgregarPromocion').show();
      }
    })
  });



      //boton CANCELAR EDICION
      $("#btnCancelarEditarPromocion").click(function () {
        limpiarFormulario();
        $('#btnCancelarEditarPromocion').hide();
        $('#btnModificarPromocion').hide();
        $('#btnAgregarPromocion').show();
      });

      //limpiar formulario
      function limpiarFormulario() {
      $("#inputIdPromocion").val('');
      $("#inputNombrePromocion").val('');
      $("#inputFecha_inicioPromocion").val('');
      $("#inputFecha_finPromocion").val('');
      $("#inputDescuentoPromocion").val('');
      $("#inputEstadoPromocion").val('');
      $("#inputIdProductoPromocion").val('');
      };

      //actualizar


  function actualizarTabla() {
  $('#tablaPromocion tbody').empty();
  getPromociones();
}

</script>

</html>