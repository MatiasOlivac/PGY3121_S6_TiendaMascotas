<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <link href="styloAdmin.css" rel="stylesheet" />

  <!-- logotipo -->
  <link rel="icon" type="image/x-icon" href="src/Logotipo.png">

  <!-- logotipo -->
  <link rel="icon" type="image/x-icon" href="src/Logotipo.png">

  <!-- Fonts and icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
    integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <title>Administrar Promociones</title>
</head>

<body>

  <!-- Navbar_AdminPromociones-->
  <nav class="navbar navbar-expand-lg border-bottom text-dark">
    <a class="navbar-brand"><img src="/src/Logotipo.png" alt="Logo" height="90px" class="rounded-circle border"></a>
    <button class="navbar-toggler " style="background: #a0d6ef91;" type="button" data-toggle="collapse"
      data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false"
      aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
      <ul class="navbar-nav">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-toggle="dropdown"
            aria-expanded="false">
            Usuarios
          </a>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="#">Administrar Usuarios</a>
            <a class="dropdown-item" href="AdminDonaciones.html">Visualizar Donaciones</a>
            <a class="dropdown-item" href="AdminRoles.html">Administrar Roles</a>
          </div>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-toggle="dropdown"
            aria-expanded="false">
            Productos
          </a>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="AdminProducto.html">Ingreso de Productos</a>
            <a class="dropdown-item" href="AdminEspecies.html">Especies</a>
            <a class="dropdown-item" href="AdminVenta.html">Ventas</a>
            <a class="dropdown-item" href="AdminDespacho.html">Despachos</a>
              <a class="dropdown-item" href="AdminSeguimiento.html">Seguimiento</a>
            <a class="dropdown-item" href="AdminDashboard.html">Resultados Ventas/dashboard</a>
          </div>
        </li>
      </ul>
    </div>
    <nav class="navbar navbar-expand-lg">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link mr-4 text-dark" href="/Login.html">Cerrar Sesion</a>
        </li>
      </ul>
    </nav>
  </nav>
  <!-- Fin navbar -->

  <!-- Inicio registro Promociones -->
  <div class="container mt-5">
    <div class="row justify-content-md-center">
      <div class="col-sm-9">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">ADMINISTRAR PROMOCIONES</h5>
            <div class="form-row">
              <div class="form-group col-m-4 mt-1">
                <label for="inputFecha_inicioPromocion">Fecha de Inicio</label>
                <input type="date" class="form-control" id="inputFecha_inicioPromocion" required>
                <input type="date" class="form-control" id="inputIdUsuarioPromocion" hidden>
                <label for="inputFecha_finPromocion">Fecha de Término</label>
                <input type="date" class="form-control" id="inputFecha_finPromocion" required>
                <input type="text" class="form-control" id="inputIdUsuarioPromocion" hidden>
                <label for="inputDescuentoPromocion">Descuento</label>
                <input type="text" class="form-control" id="inputDescuentoPromocion" required>
                <input type="text" class="form-control" id="inputIdUsuarioPromocion" hidden>
                <label for="inputEstadoPromocion">Estado</label>
                <input type="text" class="form-control" id="inputEstadoPromocion" required>
                <input type="text" class="form-control" id="inputIdUsuarioPromocion" hidden>
                <label for="inputIdProductoPromocion">ID Producto</label>
                <input type="text" class="form-control" id="inputIdProductoPromocion" required>
                <input type="text" class="form-control" id="inputIdUsuarioPromocion" hidden>
              </div>
              <div class="col-5 m-2">
                <a id="btnAgregarPromocion" class="btn btn-success col-md-4 mt-1 mt-4">Ingresar</a>
                <a id="btnModificarPromocion" class="btn btn-info col-md-4 mt-1 mt-4">Confirmar</a>
                <a id="btnCancelarEditarPromocion" class="btn btn-danger col-md-4 mt-1 mt-4">Cancelar</a>
              </div>
            </div>
            <div class="row mt-4 mb-4">
              <div class="col-sm-12">
                <div class="card" style="height: 100%;">
                  <div class="card-body">
                    <h5 class="card-title">Roles</h5>
                    <div class="table-responsive">
                      <table class="table" id="tablaRol">
                        <thead class="thead-dark">
                          <tr>
                            <th scope="col">ID_PROMOCION</th>
                            <th scope="col">FECHA_INICIO</th>
                            <th scope="col">FECHA_FIN</th>
                            <th scope="col">DESCUENTO</th>
                            <th scope="col">ESTADO</th>
                            <th scope="col">ID_PRODUCTO</th>
                            <th scope="col">NOMBRE</th>
                          </tr>
                        </thead>
                        <tbody>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Fin Registro Promocion -->

  <!-- Inicio Tabla Promocion -->

  <!-- Fin Tabla Promocion -->

</body>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"
integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
integrity="sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2"
crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- COMUNES -->
<script src="assets/js/comunes.js" ></script>


<script>

//buscar las Promociones en la api
  $(document).ready(function() {

    getPromociones();

  });


  getPromociones = () => {
  $(document).ready(function() {
    $.ajax({
      url: `${API_URL}/Promociones`,
      type: 'GET',
      dataType: 'json',
      success: function(data) {
        $.each(data, function(index, value) {
          // Obtener los datos de la promoción
          var idPromocion = value.ID_PROMOCION;
          var fechaInicio = value.FECHA_INICIO;
          var fechaFin = value.FECHA_FIN;
          var porcentajeDescuento = value.DESCUENTO;
          var estado = value.ESTADO;
          var idProducto = value.ID_PRODUCTO;

          // Realizar consulta a tabla producto
          $.ajax({
            url: `${API_URL}/AdminProducto/${idProducto}`,
            type: 'GET',
            dataType: 'json',
            success: function(producto) {
              var precioOriginal = producto.ID_PRODUCTOS;
              var precioConDescuento = calcularPrecioConDescuento(precioOriginal, porcentajeDescuento);

              // Se Agrega Con el Precio con descuento
              $('#tablaPromocion tbody').append(
                `<tr>
                  <th scope="row">${ultimoId()}</th>
                  <td>${idPromocion}</td>
                  <td>${fechaInicio}</td>
                  <td>${fechaFin}</td>
                  <td>${porcentajeDescuento}</td>
                  <td>${estado}</td>
                  <td>${idProducto}</td>
                  <td>${precioConDescuento}</td>
                  <input type="hidden" name="id_usuario" value="${idPromocion}">
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group" aria-label="Basic example">
                      <button type="button" class="btn btn-info btnEditarPromocion"><i class="fa-solid fa-pencil"></i></button>
                      <button type="button" class="btn btn-danger btnEliminarPromocion"><i class="fa-solid fa-trash"></i></button>
                    </div>
                  </td>
                </tr>`
              );
            }
          });
        });
      }
    });
  });
};


//botones invisibles
$('#btnModificarPromocion').hide();
$('#btnCancelarEditarPromocion').hide();


//añadir Promocion a la lista con jquery
  $(document).on('click', '#btnAgregarPromocion', function(){
        var FECHA_INICIO = $('#inputFecha_InicioPromocion').val();
        var FECHA_FIN = $('#inputFecha_finPromocion').val();
        var DESCUENTO = $('#inputDescuentoPromocion').val();
        var ESTADO = $('#inputEstadoPromocion').val();
        var ID_PRODUCTO = $('#inputIdProductoPromocion').val();
        

      $.ajax({
          url: `${API_URL}/Promociones`,
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
          FECHA_INICIO: FECHA_INICIO,
          FECHA_FIN: FECHA_FIN,
          DESCUENTO: DESCUENTO,
          ESTADO: ESTADO,
          ID_PRODUCTO: ID_PRODUCTO,
          })
          ,
          
          success: function(respuesta){
              console.log(respuesta);
          }

      })
    Swal.fire(
      'Promocion Ingresada!',
      'Presione "ok" para continuar.',
      'success');

      limpiarFormulario();
      actualizarTabla();
  });



//entregar ultimo id
  ultimoId = () =>{
    let ultimoId = $("#tablaPromocion tbody tr:last th").text();
    let value = parseInt(ultimoId) + 1;
    if (isNaN(value)){
      value=1
    }
    return value;
  };

  
//botón BORRAR
  $(document).on('click', '.btnEliminarPromocion', function(e){
    const swalWithBootstrapButtons = Swal.mixin({
      customClass: {
        confirmButton: 'btn btn-success',
        cancelButton: 'btn btn-danger'
      },
      buttonsStyling: false
    })

    swalWithBootstrapButtons.fire({
      title: 'Desea eliminar la Promocion?.',
      text: "Se eliminará del registro.",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Si, Eliminar!.',
      cancelButtonText: 'No, Cancelar!.',
      reverseButtons: true
    }).then((result) => {
      if (result.isConfirmed) {
        var idUsuario = $(this).closest('tr').find('td');
        var id_usuario = idUsuario.eq(0).find('input').val();
        console.log(id_usuario)
        

        $.ajax({
          url: `${API_URL}/Promociones`,
          type: 'DELETE',
          dataType: 'json',
          data: {
            ID_USUARIO : id_usuario
        },
        success: function(respuesta){
            console.log('Promocion Eliminada')
            actualizarTabla();
        }

    })
        swalWithBootstrapButtons.fire(
          'Promocion eliminada!.',
          'presione ok para finalizar.',
          'success'
        )
        actualizarTabla();
      } else if (
        result.dismiss === Swal.DismissReason.cancel
      ) {
        swalWithBootstrapButtons.fire(
          'Cancelado.',
          'La Promocion está a salvo! :D .',
          'error'
        )
      }
    })
  });



//Editar Promocion
  $("#tablaPromocion tbody").on("click", ".btnEditarPromocion", function (e) {
         $('#btnAgregarPromocion').hide();
         $('#btnModificarPromocion').show();
        e.preventDefault();
        var idPromocion = $(this).closest('tr').find('th').text();
        var nombrePromocion = $(this).closest('tr').find('td').eq(0).text().trim();
        var fechaInicio = $(this).closest('tr').find('td').eq(1).text().trim();
        var fechaFin = $(this).closest('tr').find('td').eq(2).text().trim();
        var descuento = $(this).closest('tr').find('td').eq(3).text().trim();
        var estado = $(this).closest('tr').find('td').eq(4).text().trim();
        var idProducto = $(this).closest('tr').find('td').eq(5).text().trim();
        
        $("#inputIdPromocion").val(idPromocion);
        $("#inputNombrePromocion").val(nombrePromocion);
        $("#inputFecha_inicioPromocion").val(fechaInicio);
        $("#inputFecha_finPromocion").val(fechaFin);
        $("#inputDescuentoPromocion").val(descuento);
        $("#inputEstadoPromocion").val(estado);
        $("#inputIdProductoPromocion").val(idProducto);
 
        $('#btnModificarPromocion').show();
        $('#btnCancelarEditarPromocion').show();
        $('#btnAgregarPromocion').hide();
  });




//modificar Promocion
  $("#btnModificarPromocion").click(function () {
    let fechaInicio = $("#inputFecha_inicioPromocion").val();
    let fechaFin = $("#inputFecha_finPromocion").val();
    let descuento = $("#inputDescuentoPromocion").val();
    let estado = $("#inputEstadoPromocion").val();
    let idProducto = $("#inputIdProductoPromocion").val();
    let idPromocion = $("#inputIdPromocion").val();
    
    console.log(fechaInicio);
    console.log(fechaFin);
    console.log(descuento);
    console.log(estado);
    console.log(idProducto);
    console.log(idPromocion);

    $.ajax({
          url: `${API_URL}/Promociones`,
          type: 'PATCH',
          contentType: 'application/json',
          crossDomain: true,
          data: JSON.stringify({
            FECHA_INICIO: fechaInicio,
            FECHA_FIN: fechaFin,
            DESCUENTO: descuento,
            ESTADO: estado,
            ID_PRODUCTO: idProducto,
            ID_PROMOCION: idPromocion
          }),
          success: function(respuesta){
              console.log("modificado");
              limpiarFormulario();
              actualizarTabla();
              $('#btnCancelarEditarPromocion').hide();
              $('#btnModificarPromocion').hide();
              $('#btnAgregarPromocion').show();
          }
      })
  });

      //boton CANCELAR EDICION
      $("#btnCancelarEditarPromocion").click(function () {
        limpiarFormulario();
        $('#btnCancelarEditarPromocion').hide();
        $('#btnModificarPromocion').hide();
        $('#btnAgregarPromocion').show();
      });



      //limpiar formulario
      function limpiarFormulario() {
        $("#inputNombrePromocion").val('');
        $("#inputIdPromocion").val('');
      };



      //actualizar
      function actualizarTabla() {
        $('#tablaPromocion tbody').empty();
        getPromociones();
      };


</script>

</html>