<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <link href="styloAdmin.css" rel="stylesheet" />

  <!-- logotipo -->
  <link rel="icon" type="image/x-icon" href="src/Logotipo.png">

  <!-- Fonts and icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
    integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <title>Administrar Promociones</title>
</head>

<body>

  <!-- Navbar_AdminPromociones-->
  <nav class="navbar navbar-expand-lg border-bottom text-dark">
   
    <button class="navbar-toggler " style="background: #a0d6ef91;" type="button" data-toggle="collapse"
      data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false"
      aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
      <ul class="navbar-nav">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-toggle="dropdown"
            aria-expanded="false">
            Usuarios
          </a>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="#">Administrar Usuarios</a>
            <a class="dropdown-item" href="AdminDonaciones.html">Visualizar Donaciones</a>
            <a class="dropdown-item" href="AdminRoles.html">Administrar Roles</a>
          </div>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-toggle="dropdown"
            aria-expanded="false">
            Productos
          </a>
          <div class="dropdown-menu">
            <a class="dropdown-item" href="AdminProducto.html">Ingreso de Productos</a>
            <a class="dropdown-item" href="AdminEspecies.html">Especies</a>
            <a class="dropdown-item" href="AdminVenta.html">Ventas</a>
            <a class="dropdown-item" href="AdminDespacho.html">Despachos</a>
              <a class="dropdown-item" href="AdminSeguimiento.html">Seguimiento</a>
            <a class="dropdown-item" href="AdminDashboard.html">Resultados Ventas/dashboard</a>
          </div>
        </li>
      </ul>
    </div>
    <nav class="navbar navbar-expand-lg">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link mr-4 text-dark" href="/Login.html">Cerrar Sesion</a>
        </li>
      </ul>
    </nav>
  </nav>
  <!-- Fin navbar -->

  <div class="container mt-5">
    <div class="row justify-content-md-center">
      <div class="col-sm-9">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">ADMINISTRAR SUSCRIPCIONES</h5>
            <div class="form-row">
              <div class="form-group col-m-4 mt-1">
                <label for="inputFecha_inicioSuscripcion">Fecha de Inicio</label>
                <input type="date" class="form-control" id="inputFecha_inicioSuscripcion" required>
                
                <label for="inputEstadoSuscripcion">Estado</label>
                <input type="text" class="form-control" id="inputEstadoSuscripcion" required>
                <label for="inputIdUsuarioSuscripcion">ID Usuario</label>
                <input type="text" class="form-control" id="inputIdUsuarioSuscripcion" required>
                <label for="inputMontoSuscripcion">Monto</label>
                <input type="text" class="form-control" id="inputMontoSuscripcion" required>
              </div>
              <div class="col-5 m-2">
                <a id="btnAgregarSuscripcion" class="btn btn-success col-md-4 mt-1 mt-4">Ingresar</a>
                <a id="btnModificarSuscripcion" class="btn btn-info col-md-4 mt-1 mt-4">Confirmar</a>
                <a id="btnCancelarEditarSuscripcion" class="btn btn-danger col-md-4 mt-1 mt-4">Cancelar</a>
              </div>
              </div>
              <div class="row mt-4 mb-4">
                <div class="col-sm-12">
                  <div class="card" style="height: 100%;">
                    <div class="card-body">
                      <h5 class="card-title">Suscripciones</h5>
                      <div class="table-responsive">
                        <table class="table" id="tablaSuscripcion">
                          <thead class="thead-dark">
                            <tr>
                              <th scope="col">ID_SUSCRIPTOR</th>
                              <th scope="col">FECHA_INICIO</th>
                              <th scope="col">FECHA_TERMINO</th>
                              <th scope="col">ESTADO</th>
                              <th scope="col">ID_USUARIO</th>
                              <th scope="col">MONTO</th>
                              <th scope="col">ACCIONES</th>
                            </tr>
                          </thead>
                          <tbody id="tablaSuscripcionBody">
                          </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</body>


<script> var API_URL = "http://localhost:5500/API";</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"
integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
integrity="sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2"
crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>





<script>

//buscar las Promociones en la api
 
$(document).ready(function() {
  getSuscripciones();
});

getSuscripciones = () => {
  $.ajax({
    url: `${API_URL}/Suscripcion`,
    type: 'GET',
    dataType: 'json',
    success: function(suscripciones) {
      suscripciones.forEach(function(suscripcion) {
        var idSuscriptor = suscripcion.ID_SUSCRIPTOR;
        var fechaInicio = moment(suscripcion.FECHA_INICIO).format('YYYY-MM-DD');
        var fechaTermino = moment(suscripcion.FECHA_TERMINO).format('YYYY-MM-DD');
        var estado = suscripcion.ESTADO;
        var idUsuario = suscripcion.ID_USUARIO;
        var monto = suscripcion.MONTO;

        if (idUsuario !== null && estado !== 0 && estado !== null) {
          // Agregar los datos al tbody de la tabla
          $('#tablaSuscripcionBody').append(
            `<tr>
              <td>${idSuscriptor}</td>
              <td>${fechaInicio}</td>
              <td>${fechaTermino}</td>
              <td>${estado}</td>
              <td>${idUsuario}</td>
              <td>${monto}</td>
              <td>
                <div class="btn-group btn-group-sm" role="group" aria-label="Basic example">
                  <button type="button" class="btn btn-info btnEditarSuscripcion"><i class="fa-solid fa-pencil"></i></button>
                  <button type="button" class="btn btn-danger btnEliminarSuscripcion"><i class="fa-solid fa-trash"></i></button>
                </div>
              </td>
            </tr>`
          );
        }
      });
    }
  });
};



  //botones invisibles
$('#btnModificarSuscripcion').hide();
$('#btnCancelarEditarSuscripcion').hide();

// añadir Suscripcion a la lista con jQuery
$(document).on('click', '#btnAgregarSuscripcion', function() {
  var fechaInicio = $('#inputFecha_inicioSuscripcion').val();
  var estado = $('#inputEstadoSuscripcion').val();
  var idUsuario = $('#inputIdUsuarioSuscripcion').val();
  var monto = $('#inputMontoSuscripcion').val();
  
  // Calcular la fecha de término sumando 30 días a la fecha de inicio
  var fechaTermino = moment(fechaInicio).add(30, 'days').format('YYYY-MM-DD');

  $.ajax({
    url: `${API_URL}/Suscripcion`,
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({
      FECHA_INICIO: fechaInicio,
      FECHA_TERMINO: fechaTermino,
      ESTADO: estado,
      ID_USUARIO: idUsuario,
      MONTO: monto
    }),
    success: function(respuesta) {
      Swal.fire(
        'Suscripcion Ingresada!',
        'Presione "OK" para continuar.',
        'success'
      );
      limpiarFormulario();
      actualizarTabla();
    }
  });
});

//entregar ultimo id
ultimoId = () => {
  let ultimoId = $("#tablaPromocion tbody tr:last th").text();
  let value = parseInt(ultimoId) + 1;
  if (isNaN(value)) {
    value = 1;
  }
  return value;
};

  
//botón BORRAR
$(document).on('click', '.btnEliminarSuscripcion', function(e) {
  const swalWithBootstrapButtons = Swal.mixin({
    customClass: {
      confirmButton: 'btn btn-success',
      cancelButton: 'btn btn-danger'
    },
    buttonsStyling: false
  });

  swalWithBootstrapButtons.fire({
    title: 'Desea cambiar el estado de la suscripción?',
    text: 'El estado se cambiará a 0.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Si, Cambiar estado!',
    cancelButtonText: 'No, Cancelar!',
    reverseButtons: true
  }).then((result) => {
    if (result.isConfirmed) {
      var idSuscripcion = $(this).closest('tr').find('td:first-child').text();

      // Realizar la solicitud PATCH para cambiar el estado a 0
      $.ajax({
        url: `${API_URL}/Suscripcion`,
        type: 'PATCH',
        dataType: 'json',
        data: JSON.stringify({ ESTADO: 0 }),
        contentType: 'application/json',
        success: function(respuesta) {
          console.log('Estado de la suscripción cambiado');
          // Aquí puedes realizar cualquier otra acción que necesites, como actualizar la tabla
          actualizarTabla();
          swalWithBootstrapButtons.fire(
            'Estado cambiado!',
            'Presione "OK" para finalizar.',
            'success'
          );
        },
        error: function() {
          swalWithBootstrapButtons.fire(
            'Error',
            'No se pudo cambiar el estado de la suscripción.',
            'error'
          );
        }
      });
    } else if (result.dismiss === Swal.DismissReason.cancel) {
      swalWithBootstrapButtons.fire(
        'Cancelado.',
        'El estado de la suscripción no ha sido cambiado.',
        'error'
      );
    }
  });
});

function actualizarTabla() {
  $('#tablaPromocion tbody').empty();
  getPromociones();
}

//Editar Suscripción
$("#tablaSuscripcion tbody").on("click", ".btnEditarSuscripcion", function(e) {
  $('#btnAgregarSuscripcion').hide();
  $('#btnModificarSuscripcion').show();
  e.preventDefault();

  var fila = $(this).closest('tr');
  var idSuscripcion = fila.find('td:eq(0)').text();
  var fechaInicio = fila.find('td:eq(1)').text();
  var fechaFin = fila.find('td:eq(2)').text();
  var estado = fila.find('td:eq(3)').text();
  var idUsuario = fila.find('td:eq(4)').text();
  var monto = fila.find('td:eq(5)').text();

  $("#inputIdSuscripcion").val(idSuscripcion);
  $("#inputFecha_inicioSuscripcion").val(fechaInicio);
  $("#inputFecha_finSuscripcion").val(fechaFin);
  $("#inputEstadoSuscripcion").val(estado);
  $("#inputIdUsuarioSuscripcion").val(idUsuario);
  $("#inputMontoSuscripcion").val(monto);

  $('#btnModificarSuscripcion').show();
  $('#btnCancelarEditarSuscripcion').show();
  $('#btnAgregarSuscripcion').hide();
});

//modificar Suscripción
$("#btnModificarSuscripcion").click(function() {
  var idSuscripcion = $("#inputIdSuscripcion").val();
  var fechaInicio = $("#inputFecha_inicioSuscripcion").val();
  var fechaFin = $("#inputFecha_finSuscripcion").val();
  var estado = $("#inputEstadoSuscripcion").val();
  var idUsuario = $("#inputIdUsuarioSuscripcion").val();
  var monto = $("#inputMontoSuscripcion").val();

  $.ajax({
    url: `${API_URL}/Suscripcion`,
    type: 'PATCH',
    contentType: 'application/json',
    crossDomain: true,
    data: JSON.stringify({
      FECHA_INICIO: fechaInicio,
      FECHA_TERMINO: fechaFin,
      ESTADO: estado,
      ID_USUARIO: idUsuario,
      MONTO: monto
    }),
    success: function(respuesta) {
      Swal.fire(
        'Suscripción modificada!',
        'Presione "OK" para finalizar.',
        'success'
      );
      limpiarFormulario();
      actualizarTabla();
      $('#btnCancelarEditarSuscripcion').hide();
      $('#btnModificarSuscripcion').hide();
      $('#btnAgregarSuscripcion').show();
    }
  });
});

//boton CANCELAR EDICION
$("#btnCancelarEditarSuscripcion").click(function() {
  limpiarFormulario();
  $('#btnCancelarEditarSuscripcion').hide();
  $('#btnModificarSuscripcion').hide();
  $('#btnAgregarSuscripcion').show();
});

//limpiar formulario
function limpiarFormulario() {
  $("#inputIdSuscripcion").val('');
  $("#inputFecha_inicioSuscripcion").val('');
  $("#inputFecha_finSuscripcion").val('');
  $("#inputEstadoSuscripcion").val('');
  $("#inputIdUsuarioSuscripcion").val('');
  $("#inputMontoSuscripcion").val('');
};

//actualizar tabla
function actualizarTabla() {
  $('#tablaSuscripcion tbody').empty();
  getSuscripciones();
}

</script>

</html>